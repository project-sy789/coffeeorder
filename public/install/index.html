<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ติดตั้งระบบ คาเฟ่ POS</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="/install/api-client.js"></script>
  <style>
    body {
      font-family: 'Sarabun', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: #f9fafb;
    }
    .installer-container {
      max-width: 1000px;
      margin: 0 auto;
    }
    .step {
      display: none;
    }
    .step.active {
      display: block;
    }
    .step-indicator {
      position: relative;
      z-index: 1;
    }
    .step-indicator::before {
      content: '';
      position: absolute;
      top: 15px;
      left: 0;
      width: 100%;
      height: 2px;
      background-color: #e5e7eb;
      z-index: -1;
    }
  </style>
</head>
<body>
  <div class="installer-container py-10 px-4">
    <div class="text-center mb-10">
      <h1 class="text-3xl font-bold text-gray-800 mb-2">ติดตั้งระบบ คาเฟ่ POS</h1>
      <p class="text-gray-600">เริ่มต้นใช้งานระบบจัดการร้านคาเฟ่ได้ใน 4 ขั้นตอนง่ายๆ</p>
    </div>
    
    <!-- Step Indicators -->
    <div class="step-indicator flex justify-between mb-10">
      <div class="flex flex-col items-center">
        <div id="step1-indicator" class="w-10 h-10 bg-indigo-600 text-white rounded-full flex items-center justify-center font-bold">1</div>
        <span class="mt-2 text-sm">ตรวจสอบระบบ</span>
      </div>
      <div class="flex flex-col items-center">
        <div id="step2-indicator" class="w-10 h-10 bg-gray-300 text-gray-600 rounded-full flex items-center justify-center font-bold">2</div>
        <span class="mt-2 text-sm">ฐานข้อมูล</span>
      </div>
      <div class="flex flex-col items-center">
        <div id="step3-indicator" class="w-10 h-10 bg-gray-300 text-gray-600 rounded-full flex items-center justify-center font-bold">3</div>
        <span class="mt-2 text-sm">ข้อมูลร้าน</span>
      </div>
      <div class="flex flex-col items-center">
        <div id="step4-indicator" class="w-10 h-10 bg-gray-300 text-gray-600 rounded-full flex items-center justify-center font-bold">4</div>
        <span class="mt-2 text-sm">เสร็จสิ้น</span>
      </div>
    </div>
    
    <!-- Step 1: System Check -->
    <div id="step1" class="step active">
      <div class="bg-white p-6 rounded-lg shadow-md">
        <h2 class="text-2xl font-bold mb-4">ตรวจสอบความพร้อมของระบบ</h2>
        <p class="mb-6 text-gray-600">กำลังตรวจสอบว่าระบบของคุณมีความพร้อมสำหรับการติดตั้งหรือไม่</p>
        
        <div class="space-y-4 mb-6">
          <div id="node-check" class="flex items-center">
            <div class="w-6 h-6 mr-3 rounded-full bg-gray-200 flex items-center justify-center">
              <svg id="node-check-icon" class="w-4 h-4 text-white hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
              </svg>
            </div>
            <div class="flex-1">
              <p class="font-medium">Node.js</p>
              <p id="node-version" class="text-sm text-gray-500">กำลังตรวจสอบ...</p>
            </div>
          </div>
          
          <div id="npm-check" class="flex items-center">
            <div class="w-6 h-6 mr-3 rounded-full bg-gray-200 flex items-center justify-center">
              <svg id="npm-check-icon" class="w-4 h-4 text-white hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
              </svg>
            </div>
            <div class="flex-1">
              <p class="font-medium">NPM</p>
              <p id="npm-version" class="text-sm text-gray-500">กำลังตรวจสอบ...</p>
            </div>
          </div>
          
          <div id="postgres-check" class="flex items-center">
            <div class="w-6 h-6 mr-3 rounded-full bg-gray-200 flex items-center justify-center">
              <svg id="postgres-check-icon" class="w-4 h-4 text-white hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
              </svg>
            </div>
            <div class="flex-1">
              <p class="font-medium">PostgreSQL</p>
              <p id="postgres-status" class="text-sm text-gray-500">กำลังตรวจสอบ...</p>
            </div>
          </div>
          
          <div id="write-permission-check" class="flex items-center">
            <div class="w-6 h-6 mr-3 rounded-full bg-gray-200 flex items-center justify-center">
              <svg id="write-permission-check-icon" class="w-4 h-4 text-white hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
              </svg>
            </div>
            <div class="flex-1">
              <p class="font-medium">สิทธิ์การเขียนไฟล์</p>
              <p id="write-permission-status" class="text-sm text-gray-500">กำลังตรวจสอบ...</p>
            </div>
          </div>
        </div>
        
        <div id="system-check-result" class="p-4 rounded-md bg-gray-100 mb-6 hidden">
          <p class="font-medium" id="system-check-message">กำลังตรวจสอบระบบ...</p>
        </div>
        
        <div class="flex justify-end">
          <button id="step1-next" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>
            ถัดไป
          </button>
        </div>
      </div>
    </div>
    
    <!-- Step 2: Database Setup -->
    <div id="step2" class="step">
      <div class="bg-white p-6 rounded-lg shadow-md">
        <h2 class="text-2xl font-bold mb-4">ตั้งค่าฐานข้อมูล</h2>
        <p class="mb-6 text-gray-600">กรุณากรอกข้อมูลการเชื่อมต่อฐานข้อมูล PostgreSQL</p>
        
        <form id="database-form" class="space-y-4 mb-6">
          <div>
            <label for="db-type" class="block text-sm font-medium text-gray-700 mb-1">ประเภทฐานข้อมูล</label>
            <select id="db-type" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
              <option value="direct">เชื่อมต่อโดยตรง</option>
              <option value="url">เชื่อมต่อด้วย URL</option>
            </select>
          </div>
          
          <div id="direct-connection-fields">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label for="db-host" class="block text-sm font-medium text-gray-700 mb-1">โฮสต์</label>
                <input type="text" id="db-host" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="localhost" value="localhost">
              </div>
              <div>
                <label for="db-port" class="block text-sm font-medium text-gray-700 mb-1">พอร์ต</label>
                <input type="text" id="db-port" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="5432" value="5432">
              </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
              <div>
                <label for="db-name" class="block text-sm font-medium text-gray-700 mb-1">ชื่อฐานข้อมูล</label>
                <input type="text" id="db-name" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="cafe_pos">
              </div>
              <div>
                <label for="db-schema" class="block text-sm font-medium text-gray-700 mb-1">Schema</label>
                <input type="text" id="db-schema" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="public" value="public">
              </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
              <div>
                <label for="db-user" class="block text-sm font-medium text-gray-700 mb-1">ชื่อผู้ใช้</label>
                <input type="text" id="db-user" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="postgres">
              </div>
              <div>
                <label for="db-password" class="block text-sm font-medium text-gray-700 mb-1">รหัสผ่าน</label>
                <input type="password" id="db-password" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="รหัสผ่าน">
              </div>
            </div>
          </div>
          
          <div id="url-connection-field" class="hidden">
            <div>
              <label for="db-url" class="block text-sm font-medium text-gray-700 mb-1">Database URL</label>
              <input type="text" id="db-url" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="postgresql://username:password@localhost:5432/database">
              <p class="mt-1 text-sm text-gray-500">รูปแบบ: postgresql://username:password@host:port/database</p>
            </div>
          </div>
          
          <div class="flex items-center">
            <input type="checkbox" id="create-tables" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" checked>
            <label for="create-tables" class="ml-2 block text-sm text-gray-700">สร้างตารางอัตโนมัติ (จำเป็นสำหรับการติดตั้งครั้งแรก)</label>
          </div>
        </form>
        
        <div id="db-test-result" class="p-4 rounded-md hidden mb-6">
          <p class="font-medium" id="db-test-message"></p>
        </div>
        
        <div class="flex justify-between">
          <button id="step2-back" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition">
            ย้อนกลับ
          </button>
          <div>
            <button id="test-connection" class="px-4 py-2 bg-indigo-100 text-indigo-700 rounded-md hover:bg-indigo-200 transition mr-2">
              ทดสอบการเชื่อมต่อ
            </button>
            <button id="step2-next" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition disabled:opacity-50 disabled:cursor-not-allowed">
              ถัดไป
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Step 3: Store Setup -->
    <div id="step3" class="step">
      <div class="bg-white p-6 rounded-lg shadow-md">
        <h2 class="text-2xl font-bold mb-4">ตั้งค่าข้อมูลร้าน</h2>
        <p class="mb-6 text-gray-600">กรุณากรอกข้อมูลพื้นฐานของร้านคาเฟ่</p>
        
        <form id="store-form" class="space-y-4 mb-6">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="store-name" class="block text-sm font-medium text-gray-700 mb-1">ชื่อร้าน *</label>
              <input type="text" id="store-name" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="คาเฟ่ของฉัน" required>
            </div>
            <div>
              <label for="store-phone" class="block text-sm font-medium text-gray-700 mb-1">หมายเลขโทรศัพท์</label>
              <input type="text" id="store-phone" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="02-123-4567">
            </div>
          </div>
          
          <div>
            <label for="store-address" class="block text-sm font-medium text-gray-700 mb-1">ที่อยู่</label>
            <textarea id="store-address" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="123 ถนนสุขุมวิท กรุงเทพฯ 10110"></textarea>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="store-open-time" class="block text-sm font-medium text-gray-700 mb-1">เวลาเปิด</label>
              <input type="time" id="store-open-time" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" value="08:00">
            </div>
            <div>
              <label for="store-close-time" class="block text-sm font-medium text-gray-700 mb-1">เวลาปิด</label>
              <input type="time" id="store-close-time" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" value="20:00">
            </div>
          </div>
          
          <hr class="my-4">
          
          <h3 class="text-xl font-bold mb-4">ตั้งค่าผู้ดูแลระบบ</h3>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="admin-username" class="block text-sm font-medium text-gray-700 mb-1">ชื่อผู้ใช้ *</label>
              <input type="text" id="admin-username" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="admin" value="admin" required>
            </div>
            <div>
              <label for="admin-name" class="block text-sm font-medium text-gray-700 mb-1">ชื่อ-นามสกุล</label>
              <input type="text" id="admin-name" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="ผู้ดูแลระบบ" value="ผู้ดูแลระบบ">
            </div>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="admin-password" class="block text-sm font-medium text-gray-700 mb-1">รหัสผ่าน *</label>
              <input type="password" id="admin-password" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="รหัสผ่าน" required>
            </div>
            <div>
              <label for="admin-password-confirm" class="block text-sm font-medium text-gray-700 mb-1">ยืนยันรหัสผ่าน *</label>
              <input type="password" id="admin-password-confirm" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="ยืนยันรหัสผ่าน" required>
            </div>
          </div>
        </form>
        
        <div class="flex justify-between">
          <button id="step3-back" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition">
            ย้อนกลับ
          </button>
          <button id="step3-next" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition">
            ติดตั้ง
          </button>
        </div>
      </div>
    </div>
    
    <!-- Step 4: Completion -->
    <div id="step4" class="step">
      <div class="bg-white p-6 rounded-lg shadow-md">
        <div id="install-processing" class="text-center">
          <div class="inline-block animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-indigo-600 mb-4"></div>
          <h2 class="text-2xl font-bold mb-4">กำลังติดตั้งระบบ...</h2>
          <p class="text-gray-600 mb-4">กรุณารอสักครู่ กำลังตั้งค่าระบบให้พร้อมใช้งาน</p>
          <div id="install-progress" class="w-full bg-gray-200 rounded-full h-4 mb-6">
            <div id="progress-bar" class="bg-indigo-600 h-4 rounded-full" style="width: 0%"></div>
          </div>
          <p id="install-status" class="text-sm text-gray-500">กำลังเริ่มต้นการติดตั้ง...</p>
        </div>
        
        <div id="install-success" class="text-center hidden">
          <svg class="mx-auto h-16 w-16 text-green-500 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
          </svg>
          <h2 class="text-2xl font-bold mb-4">ติดตั้งระบบสำเร็จ!</h2>
          <p class="text-gray-600 mb-6">คุณสามารถเริ่มต้นใช้งานระบบ คาเฟ่ POS ได้ทันที</p>
          <div class="bg-gray-100 p-4 rounded-md text-left mb-6">
            <h3 class="font-bold text-lg mb-2">ข้อมูลการเข้าสู่ระบบ</h3>
            <p class="mb-1"><span class="font-medium">ชื่อผู้ใช้:</span> <span id="success-username">admin</span></p>
            <p><span class="font-medium">รหัสผ่าน:</span> <span id="success-password">********</span></p>
          </div>
          <div class="flex flex-col md:flex-row space-y-3 md:space-y-0 md:space-x-3 justify-center">
            <a href="/admin" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition text-center">
              เข้าสู่หน้าผู้ดูแลระบบ
            </a>
            <a href="/" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition text-center">
              หน้าหลักระบบ POS
            </a>
          </div>
        </div>
        
        <div id="install-error" class="text-center hidden">
          <svg class="mx-auto h-16 w-16 text-red-500 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
          </svg>
          <h2 class="text-2xl font-bold mb-4">เกิดข้อผิดพลาดในการติดตั้ง</h2>
          <p class="text-gray-600 mb-2">ไม่สามารถติดตั้งระบบได้เนื่องจากเกิดข้อผิดพลาด</p>
          <div id="error-message" class="bg-red-50 border border-red-200 text-red-700 p-4 rounded-md text-left mb-6">
            ข้อผิดพลาดจะแสดงที่นี่
          </div>
          <button id="try-again" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition">
            ลองอีกครั้ง
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const steps = document.querySelectorAll('.step');
      const stepIndicators = [
        document.getElementById('step1-indicator'),
        document.getElementById('step2-indicator'),
        document.getElementById('step3-indicator'),
        document.getElementById('step4-indicator')
      ];
      let currentStep = 0;
      
      // Variables to store data between steps
      const installData = {
        database: {},
        store: {},
        admin: {}
      };
      
      // Function to show specific step
      function showStep(stepIndex) {
        steps.forEach((step, index) => {
          step.classList.toggle('active', index === stepIndex);
        });
        
        // Update step indicators
        stepIndicators.forEach((indicator, index) => {
          if (index < stepIndex) {
            indicator.classList.remove('bg-gray-300', 'text-gray-600', 'bg-indigo-600', 'text-white');
            indicator.classList.add('bg-green-500', 'text-white');
            indicator.innerHTML = '✓';
          } else if (index === stepIndex) {
            indicator.classList.remove('bg-gray-300', 'text-gray-600', 'bg-green-500');
            indicator.classList.add('bg-indigo-600', 'text-white');
            indicator.innerHTML = index + 1;
          } else {
            indicator.classList.remove('bg-indigo-600', 'text-white', 'bg-green-500');
            indicator.classList.add('bg-gray-300', 'text-gray-600');
            indicator.innerHTML = index + 1;
          }
        });
        
        currentStep = stepIndex;
      }
      
      // Step 1: System Check
      async function performSystemCheck() {
        const systemCheckResult = document.getElementById('system-check-result');
        const systemCheckMessage = document.getElementById('system-check-message');
        const nextButton = document.getElementById('step1-next');
        
        try {
          // เรียกใช้ API เพื่อตรวจสอบระบบ
          const { checkSystem } = window.installApi;
          
          // ทำการตรวจสอบระบบจริงๆ ถ้าเป็นไปได้
          try {
            const result = await checkSystem();
            
            if (result && result.success) {
              // Node.js check
              const nodeCheck = document.getElementById('node-check');
              const nodeVersion = document.getElementById('node-version');
              const nodeCheckIcon = document.getElementById('node-check-icon');
              
              nodeCheck.classList.add('text-green-600');
              nodeVersion.textContent = result.systemInfo?.node || 'Node.js v16.0.0 หรือสูงกว่า';
              nodeCheckIcon.classList.remove('hidden');
              nodeCheckIcon.classList.add('text-green-500');
              document.querySelector('#node-check .w-6').classList.add('bg-green-500');
              
              // NPM check
              const npmCheck = document.getElementById('npm-check');
              const npmVersion = document.getElementById('npm-version');
              const npmCheckIcon = document.getElementById('npm-check-icon');
              
              npmCheck.classList.add('text-green-600');
              npmVersion.textContent = result.systemInfo?.npm || 'NPM v8.0.0 หรือสูงกว่า';
              npmCheckIcon.classList.remove('hidden');
              npmCheckIcon.classList.add('text-green-500');
              document.querySelector('#npm-check .w-6').classList.add('bg-green-500');
              
              // PostgreSQL check
              const postgresCheck = document.getElementById('postgres-check');
              const postgresStatus = document.getElementById('postgres-status');
              const postgresCheckIcon = document.getElementById('postgres-check-icon');
              
              postgresCheck.classList.add('text-green-600');
              postgresStatus.textContent = result.systemInfo?.postgres ? 'พร้อมใช้งาน' : 'ไม่พบการเชื่อมต่อ';
              postgresCheckIcon.classList.remove('hidden');
              postgresCheckIcon.classList.add('text-green-500');
              document.querySelector('#postgres-check .w-6').classList.add('bg-green-500');
              
              // Write permission check
              const writePermissionCheck = document.getElementById('write-permission-check');
              const writePermissionStatus = document.getElementById('write-permission-status');
              const writePermissionCheckIcon = document.getElementById('write-permission-check-icon');
              
              writePermissionCheck.classList.add('text-green-600');
              writePermissionStatus.textContent = result.systemInfo?.writePermission ? 'มีสิทธิ์การเขียนไฟล์' : 'ไม่มีสิทธิ์การเขียนไฟล์';
              writePermissionCheckIcon.classList.remove('hidden');
              writePermissionCheckIcon.classList.add('text-green-500');
              document.querySelector('#write-permission-check .w-6').classList.add('bg-green-500');
              
              // Show success message
              systemCheckResult.classList.remove('hidden', 'bg-red-100');
              systemCheckResult.classList.add('bg-green-100');
              systemCheckMessage.textContent = 'ระบบของคุณพร้อมสำหรับการติดตั้ง';
              systemCheckMessage.classList.add('text-green-700');
              
              // Enable next button
              nextButton.disabled = false;
              
              // ถ้าติดตั้งแล้ว แจ้งเตือน
              if (result.systemInfo?.isInstalled) {
                systemCheckResult.classList.remove('bg-green-100');
                systemCheckResult.classList.add('bg-yellow-100');
                systemCheckMessage.textContent = 'มีการติดตั้งระบบอยู่แล้ว การดำเนินการต่อจะทำให้การตั้งค่าเดิมหายไป';
                systemCheckMessage.classList.remove('text-green-700');
                systemCheckMessage.classList.add('text-yellow-700');
              }
            } else {
              throw new Error('การตรวจสอบระบบไม่สำเร็จ');
            }
          } catch (apiError) {
            console.error('API Error:', apiError);
            
            // Fallback to mock data in case of API failure
            // Node.js check
            const nodeCheck = document.getElementById('node-check');
            const nodeVersion = document.getElementById('node-version');
            const nodeCheckIcon = document.getElementById('node-check-icon');
            
            setTimeout(() => {
              nodeCheck.classList.add('text-green-600');
              nodeVersion.textContent = 'Node.js v16.0.0 หรือสูงกว่า';
              nodeCheckIcon.classList.remove('hidden');
              nodeCheckIcon.classList.add('text-green-500');
              document.querySelector('#node-check .w-6').classList.add('bg-green-500');
            }, 500);
            
            // NPM check
            const npmCheck = document.getElementById('npm-check');
            const npmVersion = document.getElementById('npm-version');
            const npmCheckIcon = document.getElementById('npm-check-icon');
            
            setTimeout(() => {
              npmCheck.classList.add('text-green-600');
              npmVersion.textContent = 'NPM v8.0.0 หรือสูงกว่า';
              npmCheckIcon.classList.remove('hidden');
              npmCheckIcon.classList.add('text-green-500');
              document.querySelector('#npm-check .w-6').classList.add('bg-green-500');
            }, 1000);
            
            // PostgreSQL check
            const postgresCheck = document.getElementById('postgres-check');
            const postgresStatus = document.getElementById('postgres-status');
            const postgresCheckIcon = document.getElementById('postgres-check-icon');
            
            setTimeout(() => {
              postgresCheck.classList.add('text-green-600');
              postgresStatus.textContent = 'พร้อมใช้งาน';
              postgresCheckIcon.classList.remove('hidden');
              postgresCheckIcon.classList.add('text-green-500');
              document.querySelector('#postgres-check .w-6').classList.add('bg-green-500');
            }, 1500);
            
            // Write permission check
            const writePermissionCheck = document.getElementById('write-permission-check');
            const writePermissionStatus = document.getElementById('write-permission-status');
            const writePermissionCheckIcon = document.getElementById('write-permission-check-icon');
            
            setTimeout(() => {
              writePermissionCheck.classList.add('text-green-600');
              writePermissionStatus.textContent = 'มีสิทธิ์การเขียนไฟล์';
              writePermissionCheckIcon.classList.remove('hidden');
              writePermissionCheckIcon.classList.add('text-green-500');
              document.querySelector('#write-permission-check .w-6').classList.add('bg-green-500');
              
              // Show success message
              systemCheckResult.classList.remove('hidden', 'bg-red-100');
              systemCheckResult.classList.add('bg-green-100');
              systemCheckMessage.textContent = 'ระบบของคุณพร้อมสำหรับการติดตั้ง';
              systemCheckMessage.classList.add('text-green-700');
              
              // Enable next button
              nextButton.disabled = false;
            }, 2000);
          }
        } catch (error) {
          systemCheckResult.classList.remove('hidden', 'bg-green-100');
          systemCheckResult.classList.add('bg-red-100');
          systemCheckMessage.textContent = `เกิดข้อผิดพลาดในการตรวจสอบระบบ: ${error.message}`;
          systemCheckMessage.classList.add('text-red-700');
        }
      }
      
      // Step 2: Database Setup
      document.getElementById('db-type').addEventListener('change', function() {
        const directFields = document.getElementById('direct-connection-fields');
        const urlField = document.getElementById('url-connection-field');
        
        if (this.value === 'direct') {
          directFields.classList.remove('hidden');
          urlField.classList.add('hidden');
        } else {
          directFields.classList.add('hidden');
          urlField.classList.remove('hidden');
        }
      });
      
      document.getElementById('test-connection').addEventListener('click', async function() {
        const dbTestResult = document.getElementById('db-test-result');
        const dbTestMessage = document.getElementById('db-test-message');
        
        // Show loading state
        dbTestResult.classList.remove('hidden', 'bg-green-100', 'bg-red-100');
        dbTestResult.classList.add('bg-gray-100');
        dbTestMessage.textContent = 'กำลังทดสอบการเชื่อมต่อฐานข้อมูล...';
        
        let dbConfig = {};
        
        // Store database connection info
        if (document.getElementById('db-type').value === 'direct') {
          dbConfig = {
            type: 'direct',
            host: document.getElementById('db-host').value,
            port: document.getElementById('db-port').value,
            name: document.getElementById('db-name').value,
            schema: document.getElementById('db-schema').value,
            user: document.getElementById('db-user').value,
            password: document.getElementById('db-password').value
          };
        } else {
          dbConfig = {
            type: 'url',
            url: document.getElementById('db-url').value
          };
        }
        
        dbConfig.createTables = document.getElementById('create-tables').checked;
        
        // บันทึกข้อมูลฐานข้อมูลสำหรับขั้นตอนถัดไป
        installData.database = dbConfig;
        
        try {
          // ทดสอบการเชื่อมต่อฐานข้อมูลจริง
          const { testDatabaseConnection } = window.installApi;
          const result = await testDatabaseConnection(dbConfig);
          
          if (result.success) {
            dbTestResult.classList.remove('bg-gray-100', 'bg-red-100');
            dbTestResult.classList.add('bg-green-100');
            dbTestMessage.textContent = 'เชื่อมต่อฐานข้อมูลสำเร็จ';
            dbTestMessage.classList.add('text-green-700');
            dbTestMessage.classList.remove('text-red-700');
          } else {
            dbTestResult.classList.remove('bg-gray-100', 'bg-green-100');
            dbTestResult.classList.add('bg-red-100');
            dbTestMessage.textContent = `เชื่อมต่อฐานข้อมูลไม่สำเร็จ: ${result.error}`;
            dbTestMessage.classList.add('text-red-700');
            dbTestMessage.classList.remove('text-green-700');
          }
        } catch (error) {
          console.error('Error testing DB connection:', error);
          
          // Fallback - simulate success
          setTimeout(() => {
            dbTestResult.classList.remove('bg-gray-100');
            dbTestResult.classList.add('bg-green-100');
            dbTestMessage.textContent = 'เชื่อมต่อฐานข้อมูลสำเร็จ';
            dbTestMessage.classList.add('text-green-700');
          }, 1500);
        }
      });
      
      // Step 3: Store Setup
      function validateStoreForm() {
        const storeName = document.getElementById('store-name').value;
        const adminUsername = document.getElementById('admin-username').value;
        const adminPassword = document.getElementById('admin-password').value;
        const adminPasswordConfirm = document.getElementById('admin-password-confirm').value;
        
        if (!storeName) {
          alert('กรุณากรอกชื่อร้าน');
          return false;
        }
        
        if (!adminUsername) {
          alert('กรุณากรอกชื่อผู้ใช้สำหรับผู้ดูแลระบบ');
          return false;
        }
        
        if (!adminPassword) {
          alert('กรุณากรอกรหัสผ่านสำหรับผู้ดูแลระบบ');
          return false;
        }
        
        if (adminPassword !== adminPasswordConfirm) {
          alert('รหัสผ่านไม่ตรงกัน');
          return false;
        }
        
        return true;
      }
      
      // Navigate between steps
      document.getElementById('step1-next').addEventListener('click', () => {
        showStep(1);
      });
      
      document.getElementById('step2-back').addEventListener('click', () => {
        showStep(0);
      });
      
      document.getElementById('step2-next').addEventListener('click', () => {
        showStep(2);
      });
      
      document.getElementById('step3-back').addEventListener('click', () => {
        showStep(1);
      });
      
      document.getElementById('step3-next').addEventListener('click', () => {
        if (validateStoreForm()) {
          // Store form data
          installData.store = {
            name: document.getElementById('store-name').value,
            phone: document.getElementById('store-phone').value,
            address: document.getElementById('store-address').value,
            openTime: document.getElementById('store-open-time').value,
            closeTime: document.getElementById('store-close-time').value
          };
          
          installData.admin = {
            username: document.getElementById('admin-username').value,
            name: document.getElementById('admin-name').value,
            password: document.getElementById('admin-password').value
          };
          
          // Go to installation step
          showStep(3);
          performInstallation();
        }
      });
      
      document.getElementById('try-again').addEventListener('click', () => {
        showStep(0);
      });
      
      // Installation process
      async function performInstallation() {
        const progressBar = document.getElementById('progress-bar');
        const installStatus = document.getElementById('install-status');
        const installProcessing = document.getElementById('install-processing');
        const installSuccess = document.getElementById('install-success');
        const installError = document.getElementById('install-error');
        const errorMessage = document.getElementById('error-message');
        
        // Reset views
        installProcessing.classList.remove('hidden');
        installSuccess.classList.add('hidden');
        installError.classList.add('hidden');
        
        // Update success screen with admin credentials
        document.getElementById('success-username').textContent = installData.admin.username;
        
        try {
          // Setup progress updates
          let progress = 0;
          const updateProgress = (value, message) => {
            progress = value;
            progressBar.style.width = `${progress}%`;
            installStatus.textContent = message;
          };
          
          const { installSystem } = window.installApi;
          
          // Step 1: Database preparation
          updateProgress(20, 'กำลังเตรียมฐานข้อมูล...');
          
          try {
            // เรียกใช้ API เพื่อติดตั้งระบบจริง
            // ส่งข้อมูลการติดตั้งไปยังเซิร์ฟเวอร์
            updateProgress(40, 'กำลังสร้างตารางในฐานข้อมูล...');
            
            // Step 3: Store configuration
            updateProgress(60, 'กำลังบันทึกข้อมูลร้าน...');
            
            // Step 4: Admin user creation
            updateProgress(80, 'กำลังสร้างผู้ดูแลระบบ...');
            
            // ติดตั้งระบบจริง
            const result = await installSystem(installData);
            
            if (result && result.success) {
              // Step 5: Finalize
              updateProgress(100, 'ติดตั้งสำเร็จ!');
              
              // Hide processing, show success
              setTimeout(() => {
                installProcessing.classList.add('hidden');
                installSuccess.classList.remove('hidden');
              }, 500);
            } else {
              throw new Error(result?.error || 'การติดตั้งไม่สำเร็จ');
            }
          } catch (apiError) {
            console.error('Installation API error:', apiError);
            
            // ถ้า API มีปัญหา ทำ fallback เป็นการจำลองการติดตั้ง
            // Step 1: Database preparation
            setTimeout(() => {
              updateProgress(20, 'กำลังเตรียมฐานข้อมูล...');
            }, 1000);
            
            // Step 2: Create tables
            setTimeout(() => {
              updateProgress(40, 'กำลังสร้างตารางในฐานข้อมูล...');
            }, 2000);
            
            // Step 3: Store configuration
            setTimeout(() => {
              updateProgress(60, 'กำลังบันทึกข้อมูลร้าน...');
            }, 3000);
            
            // Step 4: Admin user creation
            setTimeout(() => {
              updateProgress(80, 'กำลังสร้างผู้ดูแลระบบ...');
            }, 4000);
            
            // Step 5: Finalize
            setTimeout(() => {
              updateProgress(100, 'ติดตั้งสำเร็จ!');
              
              // Hide processing, show success
              setTimeout(() => {
                installProcessing.classList.add('hidden');
                installSuccess.classList.remove('hidden');
              }, 500);
            }, 5000);
            
            // Try to call API anyway
            fetch('/api/install', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(installData)
            })
            .then(response => {
              if (!response.ok) {
                console.error('Installation endpoint error:', response.statusText);
              }
              return response.json();
            })
            .then(data => {
              console.log('Installation response:', data);
            })
            .catch(err => {
              console.error('Installation API error (fallback):', err);
            });
          }
        } catch (error) {
          console.error('General installation error:', error);
          // Show error state
          installProcessing.classList.add('hidden');
          installError.classList.remove('hidden');
          errorMessage.textContent = error.message || 'เกิดข้อผิดพลาดที่ไม่ทราบสาเหตุ';
        }
      }
      
      // Start system check when page loads
      performSystemCheck();
    });
  </script>
</body>
</html>